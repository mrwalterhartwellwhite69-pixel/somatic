import{l as e}from"./index-C_7n6_ZT.js";import"./vendor-5D-o_3O6.js";import"./form-W2PSSBRM.js";const t={};var r={};const i="somatic:submissionQueue_v2",s=3e5,n=1048576,a=new Set([408,429,500,502,503,504]);let o=!1,c=navigator.onLine;const u=new Set;function d(e){return u.add(e),()=>u.delete(e)}class l{static read(){try{const e=localStorage.getItem(i);if(!e)return[];const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch(t){return e("Error reading submission queue",{error:t}),[]}}static write(t){try{localStorage.setItem(i,JSON.stringify(t)),r={queueLength:t.length},u.forEach(e=>{try{e(r)}catch(t){}})}catch(s){e("Error writing submission queue",{error:s});try{const e=Object.keys(localStorage);e.length>10&&e.slice(0,5).forEach(e=>localStorage.removeItem(e)),localStorage.setItem(i,JSON.stringify(t))}catch(n){e("Failed to make space in localStorage",{error:n})}}var r}static push(t){const r=this.read();r.length>=100&&(r.splice(0,r.length-100+1),e("Queue size limit reached, removing oldest items"));const i=(new TextEncoder).encode(JSON.stringify(t.payload)).length;if(i>n)throw e("Payload size exceeds limit",{size:i,limit:n,id:t.id}),new Error("Payload size exceeds limit");r.push(t),this.write(r)}static remove(e){const t=this.read().filter(t=>t.id!==e);this.write(t)}static update(e,t){const r=this.read(),i=r.findIndex(t=>t.id===e);-1!==i&&(r[i]={...r[i],...t},this.write(r))}}function m(e){const t=Math.min(s,1e3*Math.pow(2,e)),r=.3*Math.random()*t;return Math.min(s,t+r)}async function g(i,{timeout:s=25e3,retryAttempt:n=0}={}){const o=function(){const i=t?.VITE_API_BASE||r.VITE_API_BASE||window.__RUNTIME_CONFIG__?.API_BASE||"",s=i?`${i.replace(/\/$/,"")}/api/log-visit`:"/api/log-visit";try{return new URL(s,window.location.origin),s}catch(n){return e("Invalid API endpoint",{endpoint:s,error:n}),"/api/log-visit"}}();try{const e=new AbortController,t=setTimeout(()=>e.abort(),s),r=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json","X-Retry-Attempt":n.toString()},body:JSON.stringify(i),signal:e.signal});if(clearTimeout(t),!r.ok){const e=await r.text().catch(()=>"");throw new Error(`HTTP ${r.status}: ${e}`)}return{success:!0,data:await r.json().catch(()=>({}))}}catch(c){const t="AbortError"===c.name,r=!navigator.onLine||c.message.includes("NetworkError")||c.message.includes("Failed to fetch"),i=c.status&&a.has(c.status),s=c.message.includes("ECONNREFUSED")||c.message.includes("ENOTFOUND")||c.message.includes("getaddrinfo"),u=c.message.includes("SSL")||c.message.includes("TLS")||c.message.includes("CORS");return e("Backend submission failed",{error:c,isTimeout:t,isNetwork:r,isRetryableStatus:i,isConnectionIssue:s,isSecurityIssue:u,retryAttempt:n,endpoint:o}),{success:!1,retryable:t||r||i||s,error:c}}}async function p(t){const r=`queued-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,i={id:r,createdAt:(new Date).toISOString(),attempts:0,status:"pending",payload:t};try{const e=await g(t);if(e.success)return{sent:!0,data:e.data};if(e.retryable)return l.push(i),w(),{sent:!1,queued:!0,queuedId:r};throw e.error}catch(s){return e("Submission failed",{error:s,payload:t}),l.push(i),w(),{sent:!1,queued:!0,queuedId:r,error:s}}}async function h(){if(!navigator.onLine)return;const t=l.read();if(t.length)for(const i of t)try{if("processing"===i.status)continue;if(i.attempts>=10){e("Dropping item after max retries",{item:i}),l.remove(i.id);continue}const t=m(i.attempts);if(i.lastAttempt&&Date.now()-new Date(i.lastAttempt).getTime()<t)continue;l.update(i.id,{status:"processing",lastAttempt:(new Date).toISOString(),attempts:i.attempts+1});const r=await g(i.payload,{retryAttempt:i.attempts});r.success?l.remove(i.id):r.retryable?l.update(i.id,{status:"pending",error:r.error.message}):(e("Non-retryable error, dropping item",{item:i,error:r.error}),l.remove(i.id))}catch(r){e("Error processing queue item",{error:r,item:i}),l.update(i.id,{status:"pending",error:r.message})}}function f(){const t=l.read(),r=Date.now(),i=t.filter(e=>r-new Date(e.createdAt).getTime()<6048e5);i.length<t.length&&(e("Cleaned up old queue items",{removed:t.length-i.length}),l.write(i))}function w({intervalMs:t=3e4}={}){o||(o=!0,setInterval(f,864e5),window.addEventListener("online",()=>{c=!0,h().catch(t=>e("Queue process failed on online",{error:t}))}),window.addEventListener("offline",()=>{c=!1}),setTimeout(()=>{h().catch(t=>e("Initial queue process failed",{error:t}))},2e3),setInterval(()=>{c&&h().catch(t=>e("Queue retry failed",{error:t}))},t),document.addEventListener("visibilitychange",()=>{"visible"===document.visibilityState&&c&&h().catch(()=>{})}))}function y(){const e=l.read();return{length:e.length,oldestAttempt:e.length?new Date(e[0].createdAt).getTime():null,processing:e.filter(e=>"processing"===e.status).length,failed:e.filter(e=>e.attempts>=10).length}}function S(){}const v={enqueueSubmission:p,startSubmissionQueue:w,getQueueStatus:y,subscribeToQueueStatus:d,_clearQueue:S};export{S as _clearQueue,v as default,p as enqueueSubmission,y as getQueueStatus,w as startSubmissionQueue,d as subscribeToQueueStatus};
//# sourceMappingURL=submitQueue-G1WRLlPK.js.map
